"""
Example Views Demonstrating Multi-Tenant Authorization System
Shows how to implement secure, role-based, company-scoped views
"""
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.http import JsonResponse
from django.core.exceptions import PermissionDenied
from django.views.generic import ListView, CreateView, UpdateView, DeleteView
from django.contrib.auth.mixins import LoginRequiredMixin
from django.db import transaction

from .models import Company, User, UserCompany, AuditLog
from .authorization import AuthorizationService, Permission, Action
from .decorators import (
    require_permissions, require_company_access, super_admin_required,
    company_admin_required, secure_view, api_require_permissions,
    audit_sensitive_action, log_action
)
from .forms import CompanyCreationForm, UserAssignmentForm


# =============================================================================
# SUPER ADMIN ONLY VIEWS
# =============================================================================

@super_admin_required
@audit_sensitive_action(Action.CREATE, 'company')
def create_company_view(request):
    \"\"\"Create a new company - Super Admin only\"\"\"\n    if request.method == 'POST':\n        form = CompanyCreationForm(request.POST)\n        if form.is_valid():\n            with transaction.atomic():\n                company = form.save(commit=False)\n                company.created_by = request.user\n                company.save()\n                \n                # Assign the specified user as company admin\n                assigned_user = form.cleaned_data['assign_to_user']\n                AuthorizationService.assign_user_to_company(\n                    request.user, assigned_user, company, 'admin'\n                )\n                \n                messages.success(\n                    request, \n                    f'Company \"{company.name}\" created and assigned to {assigned_user.username}'\n                )\n                return redirect('accounts:company_list')\n    else:\n        form = CompanyCreationForm()\n    \n    return render(request, 'accounts/create_company.html', {\n        'form': form,\n        'title': 'Create New Company'\n    })\n\n\n@super_admin_required\n@log_action(Action.READ, 'company')\ndef super_admin_company_list(request):\n    \"\"\"List all companies - Super Admin only\"\"\"\n    companies = Company.objects.filter(is_active=True).prefetch_related('user_assignments')\n    \n    # Add statistics for each company\n    for company in companies:\n        company.user_count = company.user_assignments.filter(is_active=True).count()\n        company.admin_count = company.user_assignments.filter(\n            is_active=True, role__in=['admin', 'manager']\n        ).count()\n    \n    return render(request, 'accounts/super_admin/company_list.html', {\n        'companies': companies,\n        'title': 'All Companies'\n    })\n\n\n@super_admin_required\n@audit_sensitive_action(Action.UPDATE, 'company')\ndef deactivate_company(request, company_id):\n    \"\"\"Deactivate a company - Super Admin only\"\"\"\n    company = get_object_or_404(Company, id=company_id)\n    \n    if request.method == 'POST':\n        with transaction.atomic():\n            company.is_active = False\n            company.save()\n            \n            # Deactivate all user assignments\n            UserCompany.objects.filter(company=company).update(is_active=False)\n            \n            AuthorizationService.log_action(\n                request.user, Action.UPDATE, 'company',\n                {\n                    'company_id': company.id,\n                    'company_name': company.name,\n                    'action': 'deactivated'\n                }\n            )\n            \n            messages.success(request, f'Company \"{company.name}\" has been deactivated')\n            return redirect('accounts:super_admin_company_list')\n    \n    return render(request, 'accounts/super_admin/deactivate_company.html', {\n        'company': company\n    })\n\n\n# =============================================================================\n# COMPANY ADMIN VIEWS\n# =============================================================================\n\n@require_permissions(Permission.VIEW_COMPANY, company_param='company_id')\n@log_action(Action.READ, 'company')\ndef company_detail(request, company_id):\n    \"\"\"View company details - Company Admin or Super Admin\"\"\"\n    company = get_object_or_404(Company, id=company_id)\n    \n    # Get company team members\n    team_members = UserCompany.objects.filter(\n        company=company, is_active=True\n    ).select_related('user').order_by('-role', 'user__first_name')\n    \n    # Check if current user can manage this company\n    can_manage = AuthorizationService.has_permission(\n        request.user, Permission.UPDATE_COMPANY, company\n    )\n    \n    return render(request, 'accounts/company_detail.html', {\n        'company': company,\n        'team_members': team_members,\n        'can_manage': can_manage\n    })\n\n\n@require_permissions(Permission.ASSIGN_USER_TO_COMPANY, company_param='company_id')\n@log_action(Action.CREATE, 'user_assignment')\ndef assign_user_to_company(request, company_id):\n    \"\"\"Assign a user to company - Company Admin or Super Admin\"\"\"\n    company = get_object_or_404(Company, id=company_id)\n    \n    if request.method == 'POST':\n        form = UserAssignmentForm(request.POST)\n        if form.is_valid():\n            try:\n                user_company = AuthorizationService.assign_user_to_company(\n                    request.user,\n                    form.cleaned_data['user'],\n                    company,\n                    form.cleaned_data['role'],\n                    form.cleaned_data.get('permissions', [])\n                )\n                \n                messages.success(\n                    request, \n                    f'{user_company.user.username} assigned to {company.name} as {user_company.role}'\n                )\n                return redirect('accounts:company_detail', company_id=company.id)\n                \n            except PermissionDenied as e:\n                messages.error(request, str(e))\n    else:\n        form = UserAssignmentForm()\n    \n    return render(request, 'accounts/assign_user.html', {\n        'form': form,\n        'company': company\n    })\n\n\n@require_permissions(Permission.REMOVE_USER_FROM_COMPANY, company_param='company_id')\n@audit_sensitive_action(Action.REVOKE_ACCESS, 'user_assignment')\ndef remove_user_from_company(request, company_id, user_id):\n    \"\"\"Remove user from company - Company Admin or Super Admin\"\"\"\n    company = get_object_or_404(Company, id=company_id)\n    target_user = get_object_or_404(User, id=user_id)\n    \n    if request.method == 'POST':\n        try:\n            AuthorizationService.remove_user_from_company(\n                request.user, target_user, company\n            )\n            messages.success(\n                request, \n                f'{target_user.username} removed from {company.name}'\n            )\n        except (PermissionDenied, ValueError) as e:\n            messages.error(request, str(e))\n        \n        return redirect('accounts:company_detail', company_id=company.id)\n    \n    # Get user's role in company for confirmation\n    user_company = get_object_or_404(\n        UserCompany, user=target_user, company=company, is_active=True\n    )\n    \n    return render(request, 'accounts/remove_user_confirmation.html', {\n        'target_user': target_user,\n        'company': company,\n        'user_company': user_company\n    })\n\n\n# =============================================================================\n# USER ACCESS VIEWS\n# =============================================================================\n\n@login_required\n@log_action(Action.READ, 'company_list')\ndef my_companies(request):\n    \"\"\"List companies user has access to\"\"\"\n    companies = AuthorizationService.get_user_companies(request.user)\n    \n    # Add user's role in each company\n    company_data = []\n    for company in companies:\n        role = AuthorizationService.get_user_role_in_company(request.user, company)\n        can_manage = AuthorizationService.has_permission(\n            request.user, Permission.UPDATE_COMPANY, company\n        )\n        \n        company_data.append({\n            'company': company,\n            'role': role,\n            'can_manage': can_manage\n        })\n    \n    return render(request, 'accounts/my_companies.html', {\n        'company_data': company_data\n    })\n\n\n@super_admin_required\n@log_action(Action.SWITCH_COMPANY, 'company')\ndef switch_company(request, company_id):\n    \"\"\"Switch active company context - Super Admin only\"\"\"\n    company = get_object_or_404(Company, id=company_id)\n    \n    # Set active company in session\n    request.session['active_company_id'] = company.id\n    \n    AuthorizationService.log_action(\n        request.user, Action.SWITCH_COMPANY, 'company',\n        {\n            'from_company_id': getattr(request, 'company', {}).get('id'),\n            'to_company_id': company.id,\n            'to_company_name': company.name\n        }\n    )\n    \n    messages.success(request, f'Switched to {company.name}')\n    \n    # Redirect based on request source\n    next_url = request.GET.get('next', 'dashboard:home')\n    return redirect(next_url)\n\n\n# =============================================================================\n# API VIEWS\n# =============================================================================\n\n@api_require_permissions(Permission.VIEW_USER, company_param='company_id')\ndef api_company_users(request, company_id):\n    \"\"\"API endpoint to get company users - JSON response\"\"\"\n    company = get_object_or_404(Company, id=company_id)\n    \n    users = UserCompany.objects.filter(\n        company=company, is_active=True\n    ).select_related('user').values(\n        'id', 'user__username', 'user__email', 'user__first_name',\n        'user__last_name', 'role', 'created_at'\n    )\n    \n    return JsonResponse({\n        'company': {\n            'id': company.id,\n            'name': company.name\n        },\n        'users': list(users),\n        'total_count': users.count()\n    })\n\n\n@api_require_permissions(Permission.VIEW_AUDIT_LOGS)\ndef api_audit_logs(request):\n    \"\"\"API endpoint for audit logs - Super Admin only\"\"\"\n    # Get query parameters\n    limit = int(request.GET.get('limit', 50))\n    offset = int(request.GET.get('offset', 0))\n    user_id = request.GET.get('user_id')\n    company_id = request.GET.get('company_id')\n    action = request.GET.get('action')\n    \n    # Build queryset\n    logs = AuditLog.objects.all().select_related('user', 'company')\n    \n    if user_id:\n        logs = logs.filter(user_id=user_id)\n    if company_id:\n        logs = logs.filter(company_id=company_id)\n    if action:\n        logs = logs.filter(action=action)\n    \n    # Apply pagination\n    total_count = logs.count()\n    logs = logs[offset:offset + limit]\n    \n    # Serialize data\n    log_data = []\n    for log in logs:\n        log_data.append({\n            'id': log.id,\n            'user': log.user.username,\n            'company': log.company.name if log.company else None,\n            'action': log.action,\n            'resource_type': log.resource_type,\n            'details': log.details,\n            'timestamp': log.timestamp.isoformat(),\n            'is_security_event': log.is_security_event,\n            'is_super_admin_action': log.is_super_admin_action\n        })\n    \n    return JsonResponse({\n        'logs': log_data,\n        'total_count': total_count,\n        'offset': offset,\n        'limit': limit\n    })\n\n\n# =============================================================================\n# CLASS-BASED VIEWS EXAMPLE\n# =============================================================================\n\nclass SecureListView(LoginRequiredMixin, ListView):\n    \"\"\"Base list view with automatic company filtering\"\"\"\n    \n    def get_queryset(self):\n        \"\"\"Filter queryset by user's accessible companies\"\"\"\n        queryset = super().get_queryset()\n        return AuthorizationService.get_filtered_queryset(\n            self.request.user, queryset, 'company'\n        )\n    \n    def dispatch(self, request, *args, **kwargs):\n        \"\"\"Add authorization context to request\"\"\"\n        request.auth_service = AuthorizationService\n        return super().dispatch(request, *args, **kwargs)\n\n\nclass CompanyScopedCreateView(LoginRequiredMixin, CreateView):\n    \"\"\"Base create view that automatically sets company context\"\"\"\n    \n    def form_valid(self, form):\n        \"\"\"Set company and audit fields before saving\"\"\"\n        if hasattr(form.instance, 'company'):\n            form.instance.company = self.request.company\n        if hasattr(form.instance, 'created_by'):\n            form.instance.created_by = self.request.user\n        \n        return super().form_valid(form)\n    \n    def dispatch(self, request, *args, **kwargs):\n        \"\"\"Ensure user has create permission\"\"\"\n        if hasattr(self, 'required_permission'):\n            AuthorizationService.enforce_permission(\n                request.user, self.required_permission, \n                getattr(request, 'company', None)\n            )\n        return super().dispatch(request, *args, **kwargs)\n\n\n# =============================================================================\n# EDGE CASES AND ERROR HANDLING\n# =============================================================================\n\n@login_required\ndef handle_multiple_companies(request):\n    \"\"\"Handle users with access to multiple companies\"\"\"\n    companies = AuthorizationService.get_user_companies(request.user)\n    \n    if not companies:\n        messages.error(request, 'You are not assigned to any companies')\n        return redirect('accounts:request_access')\n    \n    if len(companies) == 1:\n        # Single company - redirect to dashboard\n        request.session['active_company_id'] = companies[0].id\n        return redirect('dashboard:home')\n    \n    # Multiple companies - show selection\n    return render(request, 'accounts/select_company.html', {\n        'companies': companies\n    })\n\n\n@login_required\ndef handle_role_change(request):\n    \"\"\"Handle cases where user's role has changed\"\"\"\n    # Clear any cached permissions or company context\n    if 'active_company_id' in request.session:\n        company_id = request.session['active_company_id']\n        try:\n            company = Company.objects.get(id=company_id)\n            # Verify user still has access\n            if not AuthorizationService.can_access_company(request.user, company):\n                del request.session['active_company_id']\n                messages.warning(\n                    request, \n                    'Your access to the selected company has been revoked'\n                )\n                return redirect('accounts:my_companies')\n        except Company.DoesNotExist:\n            del request.session['active_company_id']\n    \n    return redirect('dashboard:home')\n\n\n@login_required\ndef access_revoked_handler(request):\n    \"\"\"Handle cases where user access has been revoked\"\"\"\n    # Clear all session data\n    request.session.flush()\n    \n    # Log the event\n    AuthorizationService.log_security_event(\n        request.user, Action.LOGOUT, 'access_revoked', \n        {'reason': 'User access was revoked'}\n    )\n    \n    messages.error(\n        request, \n        'Your access has been revoked. Please contact your administrator.'\n    )\n    \n    return redirect('accounts:login')