{% load team_filters %}
<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% block title %}DreamBiz - AI-Powered Accounting Platform{% endblock %}
    </title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      [x-cloak] { display: none !important; }

      /* Custom scrollbar for dropdown menus */
      .overflow-y-auto::-webkit-scrollbar {
        width: 6px;
      }

      .overflow-y-auto::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
      }

      .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }

      .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              dreambiz: {
                50: "#eff6ff",
                100: "#dbeafe",
                200: "#bfdbfe",
                300: "#93c5fd",
                400: "#60a5fa",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                800: "#1e40af",
                900: "#1e3a8a",
              },
            },
          },
        },
      };
    </script>

    <!-- Alpine.js for interactive components -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Load static files -->
    {% load static %}

    <!-- Bulk Operations JavaScript -->
    <script src="{% static 'js/bulk-operations.js' %}"></script>

    {% block extra_head %}{% endblock %}
  </head>
  <body class="h-full">
    {% if user.is_authenticated %}
    <!-- Authenticated Layout -->
    <div class="min-h-full" x-data="{ mobileMenuOpen: false }">
      <!-- Modern Navigation Bar -->
      <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <div class="flex h-16 items-center justify-between">
            <!-- Logo and Brand -->
            <div class="flex items-center flex-shrink-0">
              <a href="{% url 'dashboard:home' %}" class="flex items-center group">
                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-700 flex items-center justify-center shadow-lg transition-transform group-hover:scale-105">
                  <i class="fas fa-chart-line text-white text-lg"></i>
                </div>
                <div class="ml-3">
                  <span class="text-xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent">DreamBiz</span>
                  <span class="hidden lg:block text-xs text-gray-500 font-medium">Accounting Platform</span>
                </div>
              </a>
            </div>

            <!-- Desktop Navigation Menu -->
            <div class="hidden md:flex md:items-center md:space-x-1">
              <!-- Dashboard -->
              <a href="{% url 'dashboard:home' %}"
                 class="{% if request.resolver_match.namespace == 'dashboard' %}bg-blue-50 text-blue-700 border-blue-700{% else %}text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-transparent{% endif %} px-4 py-2 rounded-lg text-sm font-medium inline-flex items-center transition-all border-b-2">
                <i class="fas fa-tachometer-alt mr-2"></i>
                Dashboard
              </a>

              <!-- Finance Dropdown -->
              <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @click.away="open = false"
                        class="{% if request.resolver_match.namespace in 'invoicing,expenses,bank_reconciliation,bills,budgeting' %}bg-blue-50 text-blue-700{% else %}text-gray-600 hover:bg-gray-50 hover:text-gray-900{% endif %} px-4 py-2 rounded-lg text-sm font-medium inline-flex items-center transition-all group">
                  <i class="fas fa-coins mr-2"></i>
                  Finance
                  <i class="fas fa-chevron-down ml-2 text-xs transition-transform" :class="{ 'rotate-180': open }"></i>
                </button>
                <div x-show="open"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-100"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute left-0 mt-2 w-64 origin-top-left rounded-xl bg-white shadow-xl ring-1 ring-black ring-opacity-5 overflow-hidden z-50"
                     style="display: none;">
                  <div class="py-2 max-h-96 overflow-y-auto">
                    {% if team_permissions|has_permission:"invoicing:view" %}
                    <a href="{% url 'invoicing:invoice_list' %}" class="group flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 text-blue-600 group-hover:bg-blue-200 mr-3">
                        <i class="fas fa-file-invoice text-sm"></i>
                      </div>
                      <div>
                        <div class="font-medium">Invoicing</div>
                        <div class="text-xs text-gray-500">Create & manage invoices</div>
                      </div>
                    </a>
                    {% endif %}
                    {% if team_permissions|has_permission:"expenses:view" %}
                    <a href="{% url 'expenses:expense_list' %}" class="group flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-red-100 text-red-600 group-hover:bg-red-200 mr-3">
                        <i class="fas fa-receipt text-sm"></i>
                      </div>
                      <div>
                        <div class="font-medium">Expenses</div>
                        <div class="text-xs text-gray-500">Track expenses</div>
                      </div>
                    </a>
                    {% endif %}
                    {% if team_permissions|has_permission:'bank_reconciliation:view' %}
                    <a href="{% url 'bank_reconciliation:dashboard' %}" class="group flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 group-hover:bg-indigo-200 mr-3">
                        <i class="fas fa-university text-sm"></i>
                      </div>
                      <div>
                        <div class="font-medium">Reconciliation</div>
                        <div class="text-xs text-gray-500">Match transactions</div>
                      </div>
                    </a>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- Sales & CRM -->
              {% if team_permissions|has_permission:"sales:view" %}
              <a href="{% url 'sales:lead_list' %}"
                 class="{% if request.resolver_match.namespace == 'sales' %}bg-blue-50 text-blue-700 border-blue-700{% else %}text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-transparent{% endif %} px-4 py-2 rounded-lg text-sm font-medium inline-flex items-center transition-all border-b-2">
                <i class="fas fa-user-friends mr-2"></i>
                Sales & CRM
              </a>
              {% endif %}

              <!-- Management Dropdown -->
              <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @click.away="open = false"
                        class="{% if request.resolver_match.namespace in 'inventory,hr,welfare' %}bg-blue-50 text-blue-700{% else %}text-gray-600 hover:bg-gray-50 hover:text-gray-900{% endif %} px-4 py-2 rounded-lg text-sm font-medium inline-flex items-center transition-all">
                  <i class="fas fa-cogs mr-2"></i>
                  Management
                  <i class="fas fa-chevron-down ml-2 text-xs transition-transform" :class="{ 'rotate-180': open }"></i>
                </button>
                <div x-show="open"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-100"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute left-0 mt-2 w-64 origin-top-left rounded-xl bg-white shadow-xl ring-1 ring-black ring-opacity-5 overflow-hidden z-50"
                     style="display: none;">
                  <div class="py-2 max-h-96 overflow-y-auto">
                    {% if team_permissions|has_permission:'inventory:view' %}
                    <a href="{% url 'inventory:dashboard' %}" class="group flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-orange-100 text-orange-600 group-hover:bg-orange-200 mr-3">
                        <i class="fas fa-boxes text-sm"></i>
                      </div>
                      <div>
                        <div class="font-medium">Inventory</div>
                        <div class="text-xs text-gray-500">Stock management</div>
                      </div>
                    </a>
                    {% endif %}
                    {% if team_permissions|has_permission:'hr:view' %}
                    <a href="{% url 'hr:employee_list' %}" class="group flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-teal-100 text-teal-600 group-hover:bg-teal-200 mr-3">
                        <i class="fas fa-users text-sm"></i>
                      </div>
                      <div>
                        <div class="font-medium">HR & Payroll</div>
                        <div class="text-xs text-gray-500">Employee management</div>
                      </div>
                    </a>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- Reports & Insights -->
              <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @click.away="open = false"
                        class="{% if request.resolver_match.namespace in 'reports,ai_insights' %}bg-blue-50 text-blue-700{% else %}text-gray-600 hover:bg-gray-50 hover:text-gray-900{% endif %} px-4 py-2 rounded-lg text-sm font-medium inline-flex items-center transition-all">
                  <i class="fas fa-chart-bar mr-2"></i>
                  Analytics
                  <i class="fas fa-chevron-down ml-2 text-xs transition-transform" :class="{ 'rotate-180': open }"></i>
                </button>
                <div x-show="open"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-100"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute left-0 mt-2 w-64 origin-top-left rounded-xl bg-white shadow-xl ring-1 ring-black ring-opacity-5 overflow-hidden z-50"
                     style="display: none;">
                  <div class="py-2 max-h-96 overflow-y-auto">
                    {% if team_permissions|has_permission:'reports:view' %}
                    <a href="{% url 'reports:report_list' %}" class="group flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 text-blue-600 group-hover:bg-blue-200 mr-3">
                        <i class="fas fa-file-alt text-sm"></i>
                      </div>
                      <div>
                        <div class="font-medium">Reports</div>
                        <div class="text-xs text-gray-500">Financial reports</div>
                      </div>
                    </a>
                    {% endif %}
                    {% if team_permissions|has_permission:'ai_insights:view' %}
                    <a href="{% url 'ai_insights:insights' %}" class="group flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50 hover:text-purple-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-gradient-to-br from-purple-100 to-pink-100 text-purple-600 group-hover:from-purple-200 group-hover:to-pink-200 mr-3">
                        <i class="fas fa-brain text-sm"></i>
                      </div>
                      <div>
                        <div class="font-medium flex items-center">
                          AI Insights
                          <span class="ml-2 px-1.5 py-0.5 text-xs font-bold bg-purple-100 text-purple-700 rounded">AI</span>
                        </div>
                        <div class="text-xs text-gray-500">Smart analytics</div>
                      </div>
                    </a>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Side Actions -->
            <div class="hidden md:flex md:items-center md:space-x-3">
              
              <!-- Company Switcher (for users with multi-company access) -->
              {% if user.is_authenticated %}
              {% load accounts_tags %}
              {% get_user_companies user as user_companies %}
              {% get_company_limit_info user as limit_info %}
              
              {% if user_companies.count >= 1 %}
              <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @click.away="open = false"
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                  <i class="fas fa-building mr-2 text-gray-500"></i>
                  <span class="max-w-32 truncate">{{ request.company.name|default:user.company.name }}</span>
                  {% if can_manage_roles and user_companies.count > 1 or can_manage_roles and limit_info.can_create %}
                  <i class="fas fa-chevron-down ml-2 text-xs"></i>
                  {% endif %}
                </button>
                
                {% if can_manage_roles and user_companies.count > 1 or can_manage_roles and limit_info.can_create %}
                <!-- Company Dropdown (Admin Only) -->
                <div x-show="open"
                     x-transition
                     class="absolute right-0 mt-2 w-64 origin-top-right rounded-xl bg-white shadow-xl ring-1 ring-black ring-opacity-5 overflow-hidden z-50"
                     style="display: none;">
                  <div class="px-4 py-3 border-b border-gray-100">
                    <p class="text-xs font-semibold text-gray-500 uppercase">
                      {% if user_companies.count > 1 %}Switch Company{% else %}My Company{% endif %}
                    </p>
                  </div>
                  
                  {% if user_companies.count > 1 %}
                  <div class="py-2 max-h-64 overflow-y-auto">
                    {% for uc in user_companies %}
                    <a href="{% url 'accounts:switch_company' uc.company.id %}"
                       class="flex items-center px-4 py-3 hover:bg-blue-50 transition-colors {% if uc.company.id == request.company.id or uc.company == user.company and not request.company %}bg-blue-50{% endif %}">
                      <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">{{ uc.company.name }}</p>
                        <p class="text-xs text-gray-500">{{ uc.get_role_display }}</p>
                      </div>
                      {% if uc.company.id == request.company.id or uc.company == user.company and not request.company %}
                      <i class="fas fa-check text-blue-600"></i>
                      {% endif %}
                    </a>
                    {% endfor %}
                  </div>
                  {% endif %}
                  
                  <!-- Create Company Button with Subscription Check -->
                  {% if limit_info.can_create %}
                  <div class="px-4 py-3 border-t border-gray-100">
                    <a href="{% url 'accounts:create_company' %}" 
                       class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-700">
                      <i class="fas fa-plus mr-2"></i>
                      Create New Company
                    </a>
                    {% if limit_info.max != -1 %}
                    <p class="text-xs text-gray-500 mt-1">
                      {{ limit_info.current }} of {{ limit_info.max }} companies
                    </p>
                    {% endif %}
                  </div>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}
              {% endif %}
              
              <!-- Notifications Bell -->
              <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @click.away="open = false"
                        class="relative p-2.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg transition-all">
                  <span class="sr-only">View notifications</span>
                  <i class="fas fa-bell text-lg"></i>
                  <span class="absolute top-1.5 right-1.5 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                </button>
                
                <!-- Notifications Dropdown -->
                <div x-show="open"
                     x-transition
                     class="absolute right-0 mt-2 w-80 origin-top-right rounded-xl bg-white shadow-xl ring-1 ring-black ring-opacity-5"
                     style="display: none;">
                  <div class="px-4 py-3 border-b border-gray-100">
                    <h3 class="text-sm font-semibold text-gray-900">Notifications</h3>
                  </div>
                  <div class="max-h-80 overflow-y-auto">
                    <div class="p-4 text-center text-sm text-gray-500">
                      <i class="fas fa-bell-slash text-2xl text-gray-300 mb-2"></i>
                      <p>No new notifications</p>
                    </div>
                  </div>
                  <div class="px-4 py-3 border-t border-gray-100">
                    <a href="#" class="text-sm font-medium text-blue-600 hover:text-blue-700">View all notifications</a>
                  </div>
                </div>
              </div>
              
              <!-- User Profile Dropdown -->
              <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" @click.away="open = false"
                        type="button"
                        class="group flex items-center justify-center rounded-full p-1 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                  <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-sm shadow-md ring-2 ring-white group-hover:ring-blue-100 group-hover:scale-105 transition-transform">
                    {{ user.first_name|first|default:user.username|first|upper }}
                  </div>
                </button>
                
                <!-- Profile Dropdown Menu -->
                <div x-show="open"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-100"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95"
                     class="absolute right-0 mt-2 w-72 origin-top-right rounded-xl bg-white shadow-xl ring-1 ring-black ring-opacity-5 overflow-hidden"
                     style="display: none;">
                  <!-- User Header (Fixed) -->
                  <div class="px-4 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-blue-100">
                    <div class="flex items-center">
                      <div class="h-12 w-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg shadow-md">
                        {{ user.first_name|first|default:user.username|first|upper }}
                      </div>
                      <div class="ml-3">
                        <p class="text-sm font-bold text-gray-900">{{ user.get_full_name|default:user.username }}</p>
                        <p class="text-xs text-gray-600">{{ user.email|truncatechars:30 }}</p>
                        {% if request.company or user.company %}
                        <p class="text-xs text-blue-600 font-medium mt-0.5">{{ request.company.name|default:user.company.name }}</p>
                        {% endif %}
                      </div>
                    </div>
                  </div>

                  <!-- Scrollable Menu Items Container -->
                  <div class="max-h-96 overflow-y-auto">
                  <!-- Account Section -->
                  <div class="py-2">
                    <div class="px-3 py-1">
                      <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Account</p>
                    </div>
                    <a href="{% url 'accounts:profile' %}"
                       class="group flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-gray-100 text-gray-600 group-hover:bg-blue-100 group-hover:text-blue-600 mr-3">
                        <i class="fas fa-user text-sm"></i>
                      </div>
                      <span class="font-medium">Your Profile</span>
                    </a>
                    <a href="{% url 'accounts:profile_edit' %}"
                       class="group flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-gray-100 text-gray-600 group-hover:bg-blue-100 group-hover:text-blue-600 mr-3">
                        <i class="fas fa-edit text-sm"></i>
                      </div>
                      <span class="font-medium">Edit Profile</span>
                    </a>
                    <a href="{% url 'accounts:change_password' %}"
                       class="group flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-gray-100 text-gray-600 group-hover:bg-blue-100 group-hover:text-blue-600 mr-3">
                        <i class="fas fa-key text-sm"></i>
                      </div>
                      <span class="font-medium">Change Password</span>
                    </a>
                    <a href="{% url 'accounts:company_list' %}"
                       class="group flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-purple-100 text-purple-600 group-hover:bg-purple-200 mr-3">
                        <i class="fas fa-building text-sm"></i>
                      </div>
                      <span class="font-medium">Company Management</span>
                    </a>
                    <a href="{% url 'accounts:team_dashboard' %}"
                       class="group flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-teal-100 text-teal-600 group-hover:bg-teal-200 mr-3">
                        <i class="fas fa-users text-sm"></i>
                      </div>
                      <span class="font-medium">Team Management</span>
                    </a>
                  </div>


                  
                  <!-- Settings Section -->
                  <div class="py-2 border-t border-gray-100">
                    <div class="px-3 py-1">
                      <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Settings</p>
                    </div>
                    <a href="{% url 'accounts:notification_preferences' %}"
                       class="group flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-gray-100 text-gray-600 group-hover:bg-blue-100 group-hover:text-blue-600 mr-3">
                        <i class="fas fa-bell text-sm"></i>
                      </div>
                      <span class="font-medium">Notifications</span>
                    </a>
                    <a href="{% url 'accounts:user_preferences' %}"
                       class="group flex items-center px-4 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-gray-100 text-gray-600 group-hover:bg-blue-100 group-hover:text-blue-600 mr-3">
                        <i class="fas fa-cog text-sm"></i>
                      </div>
                      <span class="font-medium">Preferences</span>
                    </a>
                  </div>
                  </div>
                  <!-- End Scrollable Container -->

                  <!-- Logout Section (Fixed at bottom) -->
                  <div class="py-2 border-t border-gray-100 bg-gray-50">
                    <a href="{% url 'accounts:logout' %}"
                       class="group flex items-center px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 transition-colors font-medium">
                      <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-red-100 text-red-600 group-hover:bg-red-200 mr-3">
                        <i class="fas fa-sign-out-alt text-sm"></i>
                      </div>
                      <span>Sign Out</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mobile Menu Button -->
            <div class="flex items-center md:hidden">
              <button @click="mobileMenuOpen = !mobileMenuOpen"
                      type="button"
                      class="inline-flex items-center justify-center rounded-lg p-2.5 text-gray-600 hover:bg-gray-100 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="sr-only">Open main menu</span>
                <i class="fas fa-bars text-xl" x-show="!mobileMenuOpen"></i>
                <i class="fas fa-times text-xl" x-show="mobileMenuOpen" x-cloak></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Mobile Menu Panel -->
        <div x-show="mobileMenuOpen" 
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 -translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-1"
             class="md:hidden border-t border-gray-200 bg-white shadow-lg"
             style="display: none;">
          
          <!-- Navigation Links -->
          <div class="px-2 py-3 space-y-1">
            <!-- Dashboard -->
            <a href="{% url 'dashboard:home' %}"
               class="{% if request.resolver_match.namespace == 'dashboard' %}bg-blue-50 text-blue-700 border-l-4 border-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %} flex items-center px-4 py-3 text-base font-medium rounded-r-lg transition-colors">
              <div class="flex items-center justify-center w-8 h-8 rounded-lg {% if request.resolver_match.namespace == 'dashboard' %}bg-blue-100 text-blue-600{% else %}bg-gray-100 text-gray-600{% endif %} mr-3">
                <i class="fas fa-tachometer-alt text-sm"></i>
              </div>
              Dashboard
            </a>

            <!-- Sales & Finance Accordion -->
            <div x-data="{ open: false }" class="space-y-1">
              <button @click="open = !open"
                      class="{% if request.resolver_match.namespace in 'invoicing,expenses,sales,bank_reconciliation' %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-gray-50{% endif %} flex items-center justify-between w-full px-4 py-3 text-base font-medium rounded-lg transition-colors">
                <div class="flex items-center">
                  <div class="flex items-center justify-center w-8 h-8 rounded-lg {% if request.resolver_match.namespace in 'invoicing,expenses,sales,bank_reconciliation' %}bg-blue-100 text-blue-600{% else %}bg-gray-100 text-gray-600{% endif %} mr-3">
                    <i class="fas fa-coins text-sm"></i>
                  </div>
                  Sales & Finance
                </div>
                <i class="fas fa-chevron-down text-xs transition-transform" :class="{ 'rotate-180': open }"></i>
              </button>
              <div x-show="open" 
                   x-transition
                   class="pl-6 space-y-1 bg-gray-50 rounded-lg py-2"
                   style="display: none;">
                {% if team_permissions|has_permission:'invoicing:view' %}
                <a href="{% url 'invoicing:invoice_list' %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:text-blue-700 hover:bg-white rounded-lg transition-colors">
                  <i class="fas fa-file-invoice w-5 text-blue-600 mr-2"></i>
                  Invoicing
                </a>
                {% endif %}
                {% if team_permissions|has_permission:'expenses:view' %}
                <a href="{% url 'expenses:expense_list' %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:text-blue-700 hover:bg-white rounded-lg transition-colors">
                  <i class="fas fa-receipt w-5 text-red-600 mr-2"></i>
                  Expenses
                </a>
                {% endif %}
                {% if team_permissions|has_permission:'sales:view' %}
                <a href="{% url 'sales:lead_list' %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:text-blue-700 hover:bg-white rounded-lg transition-colors">
                  <i class="fas fa-user-friends w-5 text-green-600 mr-2"></i>
                  Leads & CRM
                </a>
                {% endif %}
                {% if team_permissions|has_permission:'sales:view' %}
                <a href="{% url 'sales:dashboard' %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:text-blue-700 hover:bg-white rounded-lg transition-colors">
                  <i class="fas fa-chart-line w-5 text-purple-600 mr-2"></i>
                  Sales Dashboard
                </a>
                {% endif %}
                {% if team_permissions|has_permission:'bank_reconciliation:view' %}
                <a href="{% url 'bank_reconciliation:dashboard' %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:text-blue-700 hover:bg-white rounded-lg transition-colors">
                  <i class="fas fa-university w-5 text-indigo-600 mr-2"></i>
                  Bank Reconciliation
                </a>
                {% endif %}
              </div>
            </div>

            <!-- Operations Accordion -->
            <div x-data="{ open: false }" class="space-y-1">
              <button @click="open = !open"
                      class="{% if request.resolver_match.namespace in 'inventory,hr,welfare' %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-gray-50{% endif %} flex items-center justify-between w-full px-4 py-3 text-base font-medium rounded-lg transition-colors">
                <div class="flex items-center">
                  <div class="flex items-center justify-center w-8 h-8 rounded-lg {% if request.resolver_match.namespace in 'inventory,hr,welfare' %}bg-blue-100 text-blue-600{% else %}bg-gray-100 text-gray-600{% endif %} mr-3">
                    <i class="fas fa-cogs text-sm"></i>
                  </div>
                  Operations
                </div>
                <i class="fas fa-chevron-down text-xs transition-transform" :class="{ 'rotate-180': open }"></i>
              </button>
              <div x-show="open" 
                   x-transition
                   class="pl-6 space-y-1 bg-gray-50 rounded-lg py-2"
                   style="display: none;">
                {% if team_permissions|has_permission:'inventory:view' %}
                <a href="{% url 'inventory:dashboard' %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:text-blue-700 hover:bg-white rounded-lg transition-colors">
                  <i class="fas fa-boxes w-5 text-orange-600 mr-2"></i>
                  Inventory
                </a>
                {% endif %}
                {% if team_permissions|has_permission:'hr:view' %}
                <a href="{% url 'hr:employee_list' %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 hover:text-blue-700 hover:bg-white rounded-lg transition-colors">
                  <i class="fas fa-users w-5 text-teal-600 mr-2"></i>
                  Human Resources
                </a>
                {% endif %}
              </div>
            </div>

            <!-- Reports -->
            {% if team_permissions|has_permission:'reports:view' %}
            <a href="{% url 'reports:report_list' %}"
               class="{% if request.resolver_match.namespace == 'reports' %}bg-blue-50 text-blue-700 border-l-4 border-blue-600{% else %}text-gray-700 hover:bg-gray-50{% endif %} flex items-center px-4 py-3 text-base font-medium rounded-r-lg transition-colors">
              <div class="flex items-center justify-center w-8 h-8 rounded-lg {% if request.resolver_match.namespace == 'reports' %}bg-blue-100 text-blue-600{% else %}bg-gray-100 text-gray-600{% endif %} mr-3">
                <i class="fas fa-chart-bar text-sm"></i>
              </div>
              Reports
            </a>
            {% endif %}

            <!-- AI Insights -->
            {% if team_permissions|has_permission:'ai_insights:view' %}
            <a href="{% url 'ai_insights:insights' %}"
               class="{% if request.resolver_match.namespace == 'ai_insights' %}bg-gradient-to-r from-purple-50 to-pink-50 text-purple-700 border-l-4 border-purple-600{% else %}text-gray-700 hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50{% endif %} flex items-center px-4 py-3 text-base font-medium rounded-r-lg transition-colors">
              <div class="flex items-center justify-center w-8 h-8 rounded-lg {% if request.resolver_match.namespace == 'ai_insights' %}bg-purple-100 text-purple-600{% else %}bg-gray-100 text-gray-600{% endif %} mr-3">
                <i class="fas fa-brain text-sm"></i>
              </div>
              AI Insights
              <span class="ml-2 px-2 py-0.5 text-xs font-bold bg-purple-100 text-purple-700 rounded-full">AI</span>
            </a>
            {% endif %}
          </div>

          <!-- User Profile Section (Mobile) -->
          <div class="border-t border-gray-200 bg-gray-50 px-4 py-4">
            <!-- User Info Header -->
            <div class="flex items-center mb-4">
              <div class="h-12 w-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg shadow-md">
                {{ user.first_name|first|default:user.username|first|upper }}
              </div>
              <div class="ml-3 flex-1">
                <p class="text-sm font-bold text-gray-900">{{ user.get_full_name|default:user.username }}</p>
                <p class="text-xs text-gray-600">{{ user.email|truncatechars:30 }}</p>
                {% if request.company or user.company %}
                <p class="text-xs text-blue-600 font-medium">{{ request.company.name|default:user.company.name }}</p>
                {% endif %}
              </div>
            </div>
            
            <!-- Profile Menu Links -->
            <div class="space-y-1">
              <a href="{% url 'accounts:profile' %}"
                 class="flex items-center px-3 py-2.5 text-sm font-medium text-gray-700 hover:bg-white hover:text-blue-700 rounded-lg transition-colors">
                <i class="fas fa-user w-5 text-gray-500 mr-3"></i>
                Your Profile
              </a>
              <a href="{% url 'accounts:profile_edit' %}"
                 class="flex items-center px-3 py-2.5 text-sm font-medium text-gray-700 hover:bg-white hover:text-blue-700 rounded-lg transition-colors">
                <i class="fas fa-edit w-5 text-gray-500 mr-3"></i>
                Edit Profile
              </a>
              <a href="{% url 'accounts:change_password' %}"
                 class="flex items-center px-3 py-2.5 text-sm font-medium text-gray-700 hover:bg-white hover:text-blue-700 rounded-lg transition-colors">
                <i class="fas fa-key w-5 text-gray-500 mr-3"></i>
                Change Password
              </a>
              <a href="{% url 'accounts:team_dashboard' %}"
                 class="flex items-center px-3 py-2.5 text-sm font-medium text-gray-700 hover:bg-white hover:text-blue-700 rounded-lg transition-colors">
                <i class="fas fa-users w-5 text-teal-600 mr-3"></i>
                Team Management
              </a>
              <a href="{% url 'accounts:notification_preferences' %}"
                 class="flex items-center px-3 py-2.5 text-sm font-medium text-gray-700 hover:bg-white hover:text-blue-700 rounded-lg transition-colors">
                <i class="fas fa-bell w-5 text-gray-500 mr-3"></i>
                Notifications
              </a>
              <a href="{% url 'accounts:user_preferences' %}"
                 class="flex items-center px-3 py-2.5 text-sm font-medium text-gray-700 hover:bg-white hover:text-blue-700 rounded-lg transition-colors">
                <i class="fas fa-cog w-5 text-gray-500 mr-3"></i>
                Preferences
              </a>
              
              <!-- Logout Button -->
              <a href="{% url 'accounts:logout' %}"
                 class="flex items-center px-3 py-2.5 text-sm font-bold text-red-600 hover:bg-red-50 rounded-lg transition-colors mt-2">
                <i class="fas fa-sign-out-alt w-5 mr-3"></i>
                Sign Out
              </a>
            </div>
          </div>
        </div>
      </nav>

      <!-- Main content -->
      <main class="bg-gray-50 min-h-screen">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
          {% block content %}{% endblock %}
        </div>
      </main>

      <!-- Footer -->
      <footer class="bg-white border-t border-gray-200">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <!-- Brand -->
            <div class="col-span-1">
              <div class="flex items-center mb-4">
                <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-dreambiz-500 to-dreambiz-600 flex items-center justify-center">
                  <i class="fas fa-chart-line text-white"></i>
                </div>
                <span class="ml-3 text-xl font-bold text-gray-900">DreamBiz</span>
              </div>
              <p class="text-sm text-gray-600">
                AI-Powered Accounting Platform for modern businesses
              </p>
            </div>

            <!-- Quick Links -->
            <div>
              <h3 class="text-sm font-semibold text-gray-900 uppercase tracking-wider mb-4">Quick Links</h3>
              <ul class="space-y-2">
                {% if 'view' in team_permissions.dashboard %}
                <li><a href="{% url 'dashboard:home' %}" class="text-gray-600 hover:text-dreambiz-600 text-sm">Dashboard</a></li>
                {% endif %}
                {% if 'view' in team_permissions.invoicing %}
                <li><a href="{% url 'invoicing:invoice_list' %}" class="text-gray-600 hover:text-dreambiz-600 text-sm">Invoicing</a></li>
                {% endif %}
                {% if 'view' in team_permissions.expenses %}
                <li><a href="{% url 'expenses:expense_list' %}" class="text-gray-600 hover:text-dreambiz-600 text-sm">Expenses</a></li>
                {% endif %}
                {% if 'view' in team_permissions.reports %}
                <li><a href="{% url 'reports:report_list' %}" class="text-gray-600 hover:text-dreambiz-600 text-sm">Reports</a></li>
                {% endif %}
              </ul>
            </div>

            <!-- Features -->
            <div>
              <h3 class="text-sm font-semibold text-gray-900 uppercase tracking-wider mb-4">Features</h3>
              <ul class="space-y-2">
                {% if 'view' in team_permissions.ai_insights %}
                <li><a href="{% url 'ai_insights:insights' %}" class="text-gray-600 hover:text-dreambiz-600 text-sm">AI Insights</a></li>
                {% endif %}
                {% if 'view' in team_permissions.inventory %}
                <li><a href="{% url 'inventory:dashboard' %}" class="text-gray-600 hover:text-dreambiz-600 text-sm">Inventory</a></li>
                {% endif %}
                {% if 'view' in team_permissions.hr %}
                <li><a href="{% url 'hr:employee_list' %}" class="text-gray-600 hover:text-dreambiz-600 text-sm">HR Management</a></li>
                {% endif %}
              </ul>
            </div>

            <!-- Support -->
            <div>
              <h3 class="text-sm font-semibold text-gray-900 uppercase tracking-wider mb-4">Support</h3>
              <ul class="space-y-2">
                <li><a href="#" class="text-gray-600 hover:text-dreambiz-600 text-sm">Help Center</a></li>
                <li><a href="{% url 'docs:home' %}" class="text-gray-600 hover:text-dreambiz-600 text-sm">Documentation</a></li>
                <li><a href="mailto:support@techdreamafrica.com" class="text-gray-600 hover:text-dreambiz-600 text-sm">Contact Us</a></li>
                <li><a href="{% url 'accounts:user_preferences' %}" class="text-gray-600 hover:text-dreambiz-600 text-sm">Settings</a></li>
              </ul>
            </div>
          </div>

          <div class="mt-8 pt-8 border-t border-gray-200">
            <div class="flex flex-col md:flex-row justify-between items-center">
              <p class="text-sm text-gray-600">
                &copy; {{ "now"|date:"Y" }} DreamBiz by Tech Dream Africa. All rights reserved.
              </p>
              <div class="flex space-x-6 mt-4 md:mt-0">
                <a href="#" class="text-gray-400 hover:text-gray-500">
                  <i class="fab fa-facebook-f"></i>
                </a>
                <a href="#" class="text-gray-400 hover:text-gray-500">
                  <i class="fab fa-twitter"></i>
                </a>
                <a href="#" class="text-gray-400 hover:text-gray-500">
                  <i class="fab fa-linkedin-in"></i>
                </a>
                <a href="#" class="text-gray-400 hover:text-gray-500">
                  <i class="fab fa-github"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
    {% else %}
    <!-- Unauthenticated Layout -->
    <div
      class="min-h-screen flex flex-col justify-center py-12 sm:px-6 lg:px-8"
    >
      {% block unauthenticated_content %}{% endblock %}
    </div>
    {% endif %}

    <!-- Toast Notifications Container -->
    <div class="fixed top-4 right-4 z-50 space-y-4" id="toast-container">
      <!-- Toast messages will be dynamically added here -->
    </div>

    <!-- Custom JavaScript -->
    <script>
      // Toast notification system
      function showToast(message, type = 'info') {
          const toastContainer = document.getElementById('toast-container');
          if (!toastContainer) return;

          const toast = document.createElement('div');
          const colorClasses = {
              'success': 'bg-green-500',
              'error': 'bg-red-500',
              'warning': 'bg-yellow-500',
              'info': 'bg-blue-500'
          }[type] || 'bg-blue-500';

          toast.className = `${colorClasses} text-white px-6 py-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-500 ease-in-out`;
          toast.innerHTML = `
              <div class="flex items-center justify-between">
                  <div class="flex items-center">
                      <i class="fas fa-info-circle mr-3"></i>
                      <span>${message}</span>
                  </div>
                  <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                      <i class="fas fa-times"></i>
                  </button>
              </div>
          `;

          toastContainer.appendChild(toast);

          // Auto-remove after 5 seconds
          setTimeout(() => {
              toast.classList.add('opacity-0', 'translate-x-full');
              setTimeout(() => {
                  toast.remove();
              }, 500);
          }, 5000);
      }

      // Handle Django messages
      {% if messages %}
          {% for message in messages %}
              showToast('{{ message }}', '{{ message.tags }}');
          {% endfor %}
      {% endif %}
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
