{% extends 'base.html' %} {% load static %} {% block title %}Reconciliation
Rules - DreamBiz Accounting{% endblock %} {% block content %}
<div class="min-h-screen bg-gray-50">
  <!-- Page Header -->
  <div class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Reconciliation Rules</h1>
          <p class="mt-1 text-sm text-gray-600">
            Manage automated reconciliation rules to streamline your workflow
          </p>
        </div>
        <div class="flex space-x-3">
          <a
            href="{% url 'bank_reconciliation:dashboard' %}"
            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200"
          >
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Dashboard
          </a>
          <a
            href="{% url 'bank_reconciliation:rule_create' %}"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200"
          >
            <i class="fas fa-plus mr-2"></i>
            Add New Rule
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Rules Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white overflow-hidden shadow-lg rounded-lg">
        <div class="p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div
                class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"
              >
                <i class="fas fa-check text-green-600"></i>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">
                  Active Rules
                </dt>
                <dd class="text-lg font-semibold text-green-600">
                  {{ active_rules_count|default:0 }}
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow-lg rounded-lg">
        <div class="p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div
                class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center"
              >
                <i class="fas fa-robot text-blue-600"></i>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">
                  Auto Matches
                </dt>
                <dd class="text-lg font-semibold text-blue-600">
                  {{ total_matches|default:0 }}
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow-lg rounded-lg">
        <div class="p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div
                class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center"
              >
                <i class="fas fa-percentage text-purple-600"></i>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">
                  Success Rate
                </dt>
                <dd class="text-lg font-semibold text-purple-600">
                  {{ success_rate|default:"0%" }}
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rules Table -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold text-gray-900">
            Reconciliation Rules
          </h3>
          <div class="flex space-x-2">
            <button
              type="button"
              class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              onclick="filterRules('all')"
            >
              All Rules
            </button>
            <button
              type="button"
              class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              onclick="filterRules('active')"
            >
              Active Only
            </button>
          </div>
        </div>
      </div>
      <div class="p-6">
        {% if rules %}
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Rule Name
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Criteria
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Action
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Priority
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Status
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Matches
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Actions
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for rule in rules %}
              <tr
                class="hover:bg-gray-50 transition-colors duration-200 rule-row"
                data-status="{{ rule.is_active|yesno:'active,inactive' }}"
              >
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">
                    {{ rule.name }}
                  </div>
                  {% if rule.description %}
                  <div class="text-sm text-gray-500">
                    {{ rule.description|truncatechars:50 }}
                  </div>
                  {% endif %}
                </td>
                <td class="px-6 py-4">
                  <div class="text-sm text-gray-900">
                    {% if rule.match_type == 'contains' %}
                    <span
                      class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800"
                      >Contains</span
                    >
                    {% elif rule.match_type == 'exact' %}
                    <span
                      class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"
                      >Exact Match</span
                    >
                    {% elif rule.match_type == 'starts_with' %}
                    <span
                      class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"
                      >Starts With</span
                    >
                    {% elif rule.match_type == 'regex' %}
                    <span
                      class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800"
                      >Regex</span
                    >
                    {% endif %}
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    {{ rule.match_value|truncatechars:30 }}
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {% if rule.action == 'auto_match' %}
                  <span
                    class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"
                    >Auto Match</span
                  >
                  {% elif rule.action == 'suggest_match' %}
                  <span
                    class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"
                    >Suggest Match</span
                  >
                  {% elif rule.action == 'flag_review' %}
                  <span
                    class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"
                    >Flag for Review</span
                  >
                  {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <span
                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
                  >
                    {{ rule.priority }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  {% if rule.is_active %}
                  <span
                    class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"
                    >Active</span
                  >
                  {% else %}
                  <span
                    class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800"
                    >Inactive</span
                  >
                  {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ rule.match_count|default:0 }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <div class="flex space-x-2">
                    <a
                      href="#"
                      class="text-indigo-600 hover:text-indigo-900 p-2 rounded-md hover:bg-indigo-50 transition-colors duration-200"
                      title="Edit Rule"
                    >
                      <i class="fas fa-edit"></i>
                    </a>
                    <button
                      type="button"
                      class="text-{% if rule.is_active %}yellow{% else %}green{% endif %}-600 hover:text-{% if rule.is_active %}yellow{% else %}green{% endif %}-900 p-2 rounded-md hover:bg-{% if rule.is_active %}yellow{% else %}green{% endif %}-50 transition-colors duration-200"
                      onclick="toggleRule({{ rule.pk }}, {{ rule.is_active|yesno:'false,true' }})"
                      title="{% if rule.is_active %}Deactivate{% else %}Activate{% endif %} Rule"
                    >
                      <i
                        class="fas fa-{% if rule.is_active %}pause{% else %}play{% endif %}"
                      ></i>
                    </button>
                    <button
                      type="button"
                      class="text-red-600 hover:text-red-900 p-2 rounded-md hover:bg-red-50 transition-colors duration-200"
                      onclick="deleteRule({{ rule.pk }})"
                      title="Delete Rule"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div
          class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 mt-6"
        >
          <div class="flex flex-1 justify-between sm:hidden">
            {% if page_obj.has_previous %}
            <a
              href="?page={{ page_obj.previous_page_number }}"
              class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              >Previous</a
            >
            {% endif %} {% if page_obj.has_next %}
            <a
              href="?page={{ page_obj.next_page_number }}"
              class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              >Next</a
            >
            {% endif %}
          </div>
          <div
            class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between"
          >
            <div>
              <p class="text-sm text-gray-700">
                Showing
                <span class="font-medium">{{ page_obj.start_index }}</span> to
                <span class="font-medium">{{ page_obj.end_index }}</span> of
                <span class="font-medium">{{ paginator.count }}</span> results
              </p>
            </div>
          </div>
        </div>
        {% endif %} {% else %}
        <div class="text-center py-12">
          <i class="fas fa-cogs text-4xl text-gray-300 mb-4"></i>
          <h3 class="text-lg font-medium text-gray-900 mb-2">
            No reconciliation rules yet
          </h3>
          <p class="text-gray-500 mb-6">
            Create your first rule to automate transaction matching and improve
            reconciliation efficiency.
          </p>
          <a
            href="{% url 'bank_reconciliation:rule_create' %}"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            <i class="fas fa-plus mr-2"></i>
            Create First Rule
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Rule Tips -->
    <div class="mt-8 bg-blue-50 rounded-lg p-6">
      <h4 class="text-lg font-semibold text-blue-900 mb-4">
        Reconciliation Rule Tips
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
        <div class="flex items-start">
          <i class="fas fa-lightbulb text-blue-600 mt-0.5 mr-2"></i>
          <p>
            Create specific rules for recurring transactions like payroll, rent,
            or utilities.
          </p>
        </div>
        <div class="flex items-start">
          <i class="fas fa-sort-numeric-down text-blue-600 mt-0.5 mr-2"></i>
          <p>
            Set priorities to control rule execution order - lower numbers run
            first.
          </p>
        </div>
        <div class="flex items-start">
          <i class="fas fa-search text-blue-600 mt-0.5 mr-2"></i>
          <p>
            Use "Contains" matching for flexible patterns, "Exact" for precise
            matching.
          </p>
        </div>
        <div class="flex items-start">
          <i class="fas fa-chart-line text-blue-600 mt-0.5 mr-2"></i>
          <p>
            Monitor rule performance and adjust criteria to improve matching
            accuracy.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Filter rules functionality
    window.filterRules = function (status) {
      const rows = document.querySelectorAll(".rule-row");
      const buttons = document.querySelectorAll(
        'button[onclick*="filterRules"]'
      );

      // Update button states
      buttons.forEach((btn) => {
        btn.classList.remove("bg-indigo-100", "text-indigo-700");
        btn.classList.add("bg-white", "text-gray-700");
      });

      event.target.classList.remove("bg-white", "text-gray-700");
      event.target.classList.add("bg-indigo-100", "text-indigo-700");

      // Filter rows
      rows.forEach((row) => {
        if (status === "all" || row.dataset.status === status) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    };

    // Toggle rule status
    window.toggleRule = function (ruleId, activate) {
      if (
        confirm(
          `Are you sure you want to ${
            activate ? "activate" : "deactivate"
          } this rule?`
        )
      ) {
        // Here you would make an API call to toggle the rule
        // For now, we'll just show a notification
        showNotification(
          `Rule ${activate ? "activated" : "deactivated"} successfully!`,
          "success"
        );

        // Refresh the page after a short delay
        setTimeout(() => {
          location.reload();
        }, 1500);
      }
    };

    // Delete rule
    window.deleteRule = function (ruleId) {
      if (
        confirm(
          "Are you sure you want to delete this rule? This action cannot be undone."
        )
      ) {
        // Here you would make an API call to delete the rule
        // For now, we'll just show a notification
        showNotification("Rule deleted successfully!", "success");

        // Remove the row from the table
        const row = document.querySelector(`tr[onclick*="${ruleId}"]`);
        if (row) {
          row.remove();
        }
      }
    };

    // Show notification function
    function showNotification(message, type = "info") {
      const notification = document.createElement("div");
      notification.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
        type === "success"
          ? "bg-green-100 border border-green-400 text-green-700"
          : type === "error"
          ? "bg-red-100 border border-red-400 text-red-700"
          : "bg-blue-100 border border-blue-400 text-blue-700"
      }`;

      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-${
            type === "success"
              ? "check-circle"
              : type === "error"
              ? "exclamation-circle"
              : "info-circle"
          } mr-2"></i>
          <span class="font-medium">GH{message}</span>
        </div>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Add hover effects to action buttons
    const actionButtons = document.querySelectorAll("td button, td a");
    actionButtons.forEach((button) => {
      button.addEventListener("mouseenter", function () {
        this.style.transform = "scale(1.1)";
      });

      button.addEventListener("mouseleave", function () {
        this.style.transform = "scale(1)";
      });
    });
  });
</script>
{% endblock %}
