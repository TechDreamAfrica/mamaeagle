{% extends 'base.html' %}
{% load static %}

{% block title %}Expense Analysis - DreamBiz Accounting{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 py-8">
  <!-- Page Header -->
  <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between border-b pb-4">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Expense Analysis</h1>
      <p class="text-gray-600">AI-powered expense tracking and anomaly detection</p>
    </div>
    <div>
      <a
        href="{% url 'ai_insights:insights' %}"
        class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors text-sm font-medium"
      >
        <i class="fas fa-arrow-left mr-2"></i>
        Back to Insights
      </a>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-medium text-gray-600">Total Expenses (30d)</h3>
        <i class="fas fa-receipt text-blue-500"></i>
      </div>
      <p class="text-2xl font-bold text-gray-900">GH{{ total_expenses_30d|floatformat:2 }}</p>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-medium text-gray-600">Total Expenses (90d)</h3>
        <i class="fas fa-calendar-alt text-purple-500"></i>
      </div>
      <p class="text-2xl font-bold text-gray-900">GH{{ total_expenses_90d|floatformat:2 }}</p>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-medium text-gray-600">Anomalies Detected</h3>
        <i class="fas fa-exclamation-triangle text-yellow-500"></i>
      </div>
      <p class="text-2xl font-bold text-gray-900">{{ anomalies|length }}</p>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-medium text-gray-600">Categories</h3>
        <i class="fas fa-tag text-green-500"></i>
      </div>
      <p class="text-2xl font-bold text-gray-900">{{ category_breakdown|length }}</p>
    </div>
  </div>

  <!-- Anomaly Alerts -->
  {% if anomalies %}
    <div class="bg-white rounded-lg shadow-sm mb-8">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Expense Anomalies Detected</h2>
        <span class="bg-red-100 text-red-800 text-xs font-semibold px-2.5 py-0.5 rounded">{{ anomalies|length }} Alert{{ anomalies|length|pluralize }}</span>
      </div>
      <div class="p-6">
        <div class="space-y-4">
          {% for anomaly in anomalies %}
            <div class="border-l-4 {% if anomaly.severity == 'high' %}border-red-500 bg-red-50{% else %}border-yellow-500 bg-yellow-50{% endif %} p-4 rounded-r-lg">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-center mb-2">
                    <i class="fas fa-exclamation-circle {% if anomaly.severity == 'high' %}text-red-600{% else %}text-yellow-600{% endif %} mr-2"></i>
                    <h3 class="font-semibold text-gray-900">{{ anomaly.category }}</h3>
                    <span class="ml-2 bg-white px-2 py-1 rounded text-xs font-medium {% if anomaly.severity == 'high' %}text-red-600{% else %}text-yellow-600{% endif %}">
                      {{ anomaly.severity|upper }}
                    </span>
                  </div>
                  <p class="text-gray-700 mb-3">{{ anomaly.description }}</p>
                  <div class="grid grid-cols-2 gap-4 bg-white bg-opacity-60 rounded-lg p-3">
                    <div>
                      <p class="text-xs text-gray-600 mb-1">30-Day Average:</p>
                      <p class="text-sm font-semibold text-gray-900">GH{{ anomaly.amount_30d|floatformat:2 }}</p>
                    </div>
                    <div>
                      <p class="text-xs text-gray-600 mb-1">90-Day Average:</p>
                      <p class="text-sm font-semibold text-gray-900">GH{{ anomaly.amount_90d|floatformat:2 }}</p>
                    </div>
                  </div>
                </div>
                <div class="ml-4 text-right">
                  <p class="text-2xl font-bold {% if anomaly.severity == 'high' %}text-red-600{% else %}text-yellow-600{% endif %}">
                    +{{ anomaly.increase_percentage|floatformat:0 }}%
                  </p>
                  <p class="text-xs text-gray-600 mt-1">Increase</p>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% else %}
    <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-r-lg mb-8">
      <div class="flex items-center">
        <i class="fas fa-check-circle text-green-600 fa-2x mr-4"></i>
        <div>
          <h3 class="font-semibold text-green-900 mb-1">No Anomalies Detected</h3>
          <p class="text-green-700">Your expenses are within normal ranges. Keep up the good work!</p>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Category Breakdown -->
    <div class="bg-white rounded-lg shadow-sm">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Expense by Category</h2>
      </div>
      <div class="p-6">
        <canvas id="categoryPieChart"></canvas>
      </div>
    </div>

    <!-- Monthly Trend -->
    <div class="bg-white rounded-lg shadow-sm">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Monthly Expense Trend</h2>
      </div>
      <div class="p-6">
        <canvas id="monthlyTrendChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Category Breakdown Table -->
  <div class="bg-white rounded-lg shadow-sm mb-8">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Detailed Category Breakdown</h2>
    </div>
    <div class="p-6">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% of Total</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction Count</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for cat in category_breakdown %}
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="h-3 w-3 rounded-full mr-3" style="background-color: {{ cat.color }}"></div>
                    <span class="text-sm font-medium text-gray-900">{{ cat.category }}</span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">GH{{ cat.amount|floatformat:2 }}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="w-24 bg-gray-200 rounded-full h-2 mr-2">
                      <div class="bg-blue-600 h-2 rounded-full" style="width: {{ cat.percentage }}%"></div>
                    </div>
                    <span class="text-sm text-gray-600">{{ cat.percentage|floatformat:1 }}%</span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ cat.count }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Top Expenses -->
  <div class="bg-white rounded-lg shadow-sm">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">Top 10 Recent Expenses</h2>
    </div>
    <div class="p-6">
      <div class="space-y-3">
        {% for expense in top_expenses %}
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
            <div class="flex-1">
              <h4 class="font-medium text-gray-900">{{ expense.description }}</h4>
              <p class="text-sm text-gray-600 mt-1">
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                  {{ expense.category }}
                </span>
                <span class="ml-2 text-gray-500">{{ expense.date }}</span>
              </p>
            </div>
            <div class="text-right">
              <p class="text-lg font-bold text-gray-900">GH{{ expense.amount|floatformat:2 }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Category Pie Chart
  const pieCtx = document.getElementById('categoryPieChart').getContext('2d');
  new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: [{% for cat in category_breakdown %}'{{ cat.category }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        data: [{% for cat in category_breakdown %}{{ cat.amount }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: [{% for cat in category_breakdown %}'{{ cat.color }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.label + ': $' + context.parsed.toLocaleString();
            }
          }
        }
      }
    }
  });

  // Monthly Trend Chart
  const trendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
  new Chart(trendCtx, {
    type: 'bar',
    data: {
      labels: [{% for month in monthly_trend %}'{{ month.month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Monthly Expenses',
        data: [{% for month in monthly_trend %}{{ month.amount }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: 'rgba(59, 130, 246, 0.8)',
        borderColor: 'rgb(59, 130, 246)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'GH' + value.toLocaleString();
            }
          }
        }
      }
    }
  });
});
</script>
{% endblock %}
